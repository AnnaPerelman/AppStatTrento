---
title: "Clustering and Heatmaps"
author: "Calogero Zarbo"
date: "March 17, 2016"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


Create a random matrix with no correlation in the following way:

```{r}
set.seed(1)
r = 10000
c = 24
x = matrix(rnorm(r*c), r, c)
colnames(x) = 1:c
```

Run hierarchical clustering on this data with the `hclust` function with default parameters to cluster the columns. Create a dendrogram.

```{r}
clust <- hclust(dist(t(x)))
plot(as.dendrogram(clust))
```

In the dendrogram, which pairs of samples are the furthest away from each other?

* A) 7 and 23
* B) 19 and 14
* C) 1 and 16
* D) 17 and 18
```{r}
print("D) 17 and 18")

```


Set the seed at 1, `set.seed(1)` and replicate the creation of this matrix:

```{r}
set.seed(1)
r = 10000
c = 24
x = matrix(rnorm(r*c), r, c)
```

then perform hierarchical clustering as in the solution to exercise 1, and find the number of clusters if you use cuttree at height 143. This number is a random variable.

```{r}
clustering <- hclust(dist(t(x)))
hclusters <- cutree(clustering, h=143)
table(cluster=hclusters)
```


Run `kmeans` with 4 centers for the blood RNA data:

```{r}
library(GSE5859Subset)
data(GSE5859Subset)
```

Set the seed to 10, `set.seed(10)` right before running `kmeans` with 5 centers.

```{r}
clustering <- hclust(dist(t(geneExpression)))
plot(as.dendrogram(clustering))
hclusters <- cutree(clustering, h=40)

set.seed(10)
km <- kmeans(t(geneExpression), centers=5)

table(Kmeans=km$cluster, Hclust=hclusters)
```

Explore the relationship of clusters and information in `sampleInfo`. Which of the following best describes what you find?

* A) `sampleInfo$group` is driving the clusters as the 0s and 1s are in completely different clusters.
* B) The year is driving the clusters.
* C) Date is driving the clusters.
* D) The clusters donâ€™t depend on any of the column of `sampleInfo`

```{r}
table(sampleInfo$group)
table(sampleInfo$ethnicity)
table(sampleInfo$date)

print("C) Date is driving the clusters.")
```


Load the data:

```{r}
library(GSE5859Subset)
data(GSE5859Subset)
```

Pick the 25 genes with the highest across sample variance. This function might help:

```{r}

library(matrixStats)

h25 <- which( rank(-rowMads(geneExpression)) <= 25 )
```

Use `heatmap.2` to make a heatmap showing the `sampleInfo$group` with color, the date as labels, the rows labelled with chromosome, and scaling the rows.

```{r, echo=FALSE}
library(gplots)
heatmap.2(geneExpression[h25,],
          col=redgreen(50),
          labRow=geneAnnotation$CHR[geneAnnotation$PROBEID %in% rownames(geneExpression[h25,])],
          labCol=sampleInfo$date,
          scale=c("row"))
```

What do we learn from this heatmap?

* A) The data appears as if it was generated by rnorm.
* B) Some genes in chr1 are very variable.
* C) A group of chrY genes are higher in group 0 and appear to drive the clustering. Within those clusters there appears to be clustering by month.
* D) A group of chrY genes are higher in October compared to June and appear to drive the clustering. Within those clusters there appears to be clustering by samplInfo$group.

```{r}

print("D) A group of chrY genes are higher in October compared to June and appear to drive the clustering. Within those clusters there appears to be clustering by samplInfo$group.")

```


Create a large data set of random data that is completely independent of `sampleInfo$group` like this:

```{r}
set.seed(17)
r = nrow(geneExpression)
c = ncol(geneExpression)
x = matrix(rnorm(r*c), r, c)
g = factor(sampleInfo$g)
```

Create two heatmaps with these data. Show the group g either with labels or colors. First, take the 50 genes with smallest p-values obtained with `rowttests`. Then, take the 50 genes with largest standard deviations.

```{r}

library(genefilter)
library(pheatmap)

groups <- data.frame(group=g)
rownames(groups) <- colnames(x)

groups_colors <- list(group=c("black", "grey"))
names(groups_colors[[1]]) <- c(0, 1)

smallest_p <- x[rowttests(x)$p.value %in% sort(rowttests(x)$p.value)[1:50],]
pheatmap::pheatmap(smallest_p, annotation_colors=groups_colors, annotation_col=groups)

largest_sd <- x[transform(x, SD=rowSds(x, na.rm=TRUE))$SD %in% sort(transform(x, SD=rowSds(x, na.rm=TRUE))$SD, decreasing=TRUE)[1:50],]
pheatmap::pheatmap(largest_sd, annotation_colors=groups_colors,annotation_col=groups)
```
